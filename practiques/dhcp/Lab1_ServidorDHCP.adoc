= M07UF3NF2 PAC1 Servidor DHCP
:encoding: utf-8
// :slides:
:lang: ca
:toc: left
:!numbered:
//:teacher:

ifdef::teacher[]
== (Versió del professor):
endif::teacher[]

////
ifndef::teacher[]
.Entregar
====
*Resposta*
====
endif::teacher[]
ifdef::teacher[]
.Solució
====
*Solució*
====
endif::teacher[]
////

<<<

== Objectiu de la pràctica

Configurar una màquina com a servidor DHCP i dues màquines com a clients del
servei.

== Preparatius

* Utilitzarem l'entorn de xarxa local creat durant la pràctica anterior.

* Concretament, hem de configurar la màquina *bilbo* com a servidor DHCP i les
màquines *PC1* i *PC2* com a clients. El router *saruman* ha d'estar engegat
per permetre la comunicació entre les màquines. El router *sauron* ha d'estar
engegat si volem que tinguin connexió externa.

* Seguint els passos de la pràctica anterior, totes les màquines han de mostrar
un prompt personalitzat i hi ha d'haver un usuari amb el vostre nom i permisos
per utilitzar *sudo*.

[IMPORTANT]
====
Cal que configureu el vostre terminal perquè al prompt aparegui el vostre nom i
la data ressaltats en diferents colors. *Això és imprescindible per avaluar
les captures*.
====

=== Interferències amb el servidor DHCP del centre

* És important garantir que el servidor DHCP que configurem no dóna servei
a la xarxa del centre, perquè podria fer interferències amb el servidor DHCP
real i provocar que la xarxa funcionés malament.

* Tal com ho tenim configurat això ja no pot passar, perquè *bilbo* només dóna
servei a la xarxa local on està connectat.

== Apartat 1: Preparació de la màquina *bilbo*

En principi *bilbo* ja està preparat després d'acabar la pràctica anterior.

Comprovem però el seu funcionament:

ifndef::teacher[]
.Entregar
====
*Captura del contingut del fitxer `/etc/network/interfaces` de _bilbo_.*
====
endif::teacher[]
ifdef::teacher[]
.Solució
====
*Solució*
====
endif::teacher[]

ifndef::teacher[]
.Entregar
====
*Captura del resultat d'executar `traceroute 8.8.8.8` a _bilbo_.*
====
endif::teacher[]
ifdef::teacher[]
.Solució
====
*Solució*
====
endif::teacher[]

== Apartat 2: Instal·lació del servidor DHCP a *bilbo*

* Cerqueu el nom del paquet que conté el servidor DHCP a Debian i instal·leu-lo.

ifndef::teacher[]
.Entregar
====
*Captura de la comanda que instal·la el servidor DHCP.*
====
endif::teacher[]
ifdef::teacher[]
.Solució
====
*Solució*
====
endif::teacher[]

El servidor DHCP no funciona directament quan s'instal·la. Cal modificar
dos fitxers de configuració per indicar les opcions que volem.

El primer fitxer és `/etc/default/isc-dhcp-server`. Aquí cal modificar el
paràmetre `INTERFACES` per indicar que s'han de servir IP dinàmiques a
les peticions que arribin a l'única interfície de xarxa que té *bilbo*.

ifndef::teacher[]
.Entregar
====
*Captura del contingut del fitxer `/etc/default/isc-dhcp-server`.*
====
endif::teacher[]
ifdef::teacher[]
.Solució
====
*Solució*
====
endif::teacher[]

A part d'això, hem de modificar el fitxer principal de configuració del
servidor DHCP amb les opcions que volem.

* Quin és el nom de l'arxiu de configuració del servei DHCP? Quan modifiquem
l'arxiu, quina instrucció haurem d'executar per a què el servidor recarregui la
nova configuració?

ifndef::teacher[]
.Entregar
====
*Ruta completa a l'arxiu de configuració.*

*Instrucció utilitzada per reiniciar el servidor.*
====
endif::teacher[]
ifdef::teacher[]
.Solució
====
*Solució*
====
endif::teacher[]

* Inseriu una captura del registre del sistema mostrant els missatges que
llença el servidor DHCP.

[source,bash]
----
sudo cat /var/log/syslog | grep dhcpd
----

ifndef::teacher[]
.Entregar
====
*Captura del resultat de la instrucció anterior.*
====
endif::teacher[]
ifdef::teacher[]
.Solució
====
*Solució*
====
endif::teacher[]

ifndef::teacher[]
.Entregar
====
*Explica el significat dels missatges de la captura anterior. Què estem veient?*
====
endif::teacher[]
ifdef::teacher[]
.Solució
====
*Solució*
====
endif::teacher[]

== Apartat 3: Servidor DHCP a la mateixa xarxa

Volem configurar el servidor DHCP per tal que doni IP als ordinadors de la
xarxa 172.16.3.0/24.

* El servidor DHCP proporcionarà la següent configuració a *totes* les màquines
client, independentment del seu segment de xarxa:

. Servidor DNS primari: 172.16.3.2
. Servidor DNS secundari: 172.16.3.22
. Nom de domini: cognom1-cognom2.test. Per exemple en Pere Roca Grau tindrà un
nom de domini roca-grau.test.
. Temps de concessió per defecte: una hora.
. Temps de concessió màxim: dues hores.

* Per a la xarxa 172.16.3.0/24, configurarem les següents opcions:

. EL servei DHCP repartirà adreces IP en el rang 172.16.3.100 –
172.16.3.254 (ambdues incloses).
. La porta d'enllaç serà 172.16.3.1.

ifndef::teacher[]
.Entregar
====
*Arxiu de configuració complet, esborreu tots els comentaris i feu-lo llegible.*
====
endif::teacher[]
ifdef::teacher[]
.Solució
====
*Solució*
====
endif::teacher[]

ifndef::teacher[]
.Entregar
====
*Captura reinici del servei DHCP*
====
endif::teacher[]
ifdef::teacher[]
.Solució
====
*Solució*
====
endif::teacher[]

== Apartat 4: Configuració de la màquina client PC1 (a la mateixa xarxa)

* Connectem temporalment la màquina PC1 a la xarxa 172.16.3.0/24. Això ho fem
directament des del VirtualBox, connectant la seva targeta de xarxa al
switch _intnet3_.

* Configurem les ip de la màquina PC1 de manera que eth0 adquireixi ip
mitjançant dhcp. Hauria d'estar així per defecte.

ifndef::teacher[]
.Entregar
====
*Mostrar configuració de xarxa de _PC1_*
====
endif::teacher[]
ifdef::teacher[]
.Solució
====
*Solució*
====
endif::teacher[]

* A *bilbo* seguiu els canvis al fitxer de registre del sistema amb `tail -f
 /var/log/syslog`.

* Forceu la renovació de l'adreça IP a PC1 amb `dhclient`, o a través
del NetworkManager.

ifndef::teacher[]
.Entregar
====
*Comanda per reiniciar el NetworkManager o comanda per demanar una nova IP
amb `dhclient`*
====
endif::teacher[]
ifdef::teacher[]
.Solució
====
*Solució*
====
endif::teacher[]

* Observeu les noves línies que han aparegut al `syslog` de *bilbo*.

ifndef::teacher[]
.Entregar
====
*Captura de les últimes línies del `syslog` de _bilbo_.*
====
endif::teacher[]
ifdef::teacher[]
.Solució
====
*Solució*
====
endif::teacher[]

* Observeu el tràfic generat a l'apartat anterior utilitzant el
tcpdump a *bilbo*. Utilitza les opcions -n i -v al tcpdump. -n evita que
s'intentin resoldre els noms (encara no tenim el DNS funcionant), i -v fa que
es mostri la informació completa del paquet capturat.
. Feu que PC1 sol·liciti una nova concessió DHCP.
. Captureu les trames de tot el procés (DHCPDiscover, DHCPOffer, DHCPRequest,
  DHCPAck).

ifndef::teacher[]
.Entregar
====
*Captura de pantalla amb la sortida del tcpdump.*
====
endif::teacher[]
ifdef::teacher[]
.Solució
====
*Solució*
====
endif::teacher[]

* Des de la màquina PC1 verificar que tots els paràmetres adquirits són correctes.

ifndef::teacher[]
.Entregar
====
*Validar l'adreça ip*
====
endif::teacher[]
ifdef::teacher[]
.Solució
====
*Solució*
====
endif::teacher[]

ifndef::teacher[]
.Entregar
====
*Validar la porta d'enllaç*
====
endif::teacher[]
ifdef::teacher[]
.Solució
====
*Solució*
====
endif::teacher[]

ifndef::teacher[]
.Entregar
====
*Validar servidors dns*
====
endif::teacher[]
ifdef::teacher[]
.Solució
====
*Solució*
====
endif::teacher[]

* Forceu al client la renovació de l'adreça. Des del servidor, localitzeu
l'arxiu on s'emmagatzema el registre de les cessions DHCP, i trobeu el
fragment on s'ha registrat l'operació anterior. Ressalta la IP i l'hora de
cessió i l'hora de caducitat de la cessió.

ifndef::teacher[]
.Entregar
====
*Captura de la instrucció i el resultat*
====
endif::teacher[]
ifdef::teacher[]
.Solució
====
*Solució*
====
endif::teacher[]

[TIP]
====
*Les hores que es guarden a l'arxiu de concessions són en format GMT+0 (hora
  respecte al meridià de Greenwich) Si teniu ben configurada la zona horària,
  nosaltres estem a la zona GMT+1,  i trobareu una diferència negativa d'una hora*.
====

* A la màquina PC1 descobriu l'adreça MAC de la targeta eth0 des de línia de
comandes.

ifndef::teacher[]
.Entregar
====
*Captura de la instrucció i el resultat*
====
endif::teacher[]
ifdef::teacher[]
.Solució
====
*Solució*
====
endif::teacher[]

* A la màquina *bilbo* modifiqueu la configuració del servei dhcp. Volem que
les següents màquines (fícticies) de la subxarxa 172.16.3.0/24 tinguin una IP
reservada fixa:

. SERVIDOR_WEB: Té la MAC 00:0c:76:8b:c4:16. Volem que se li assigni la IP
172.16.3.5.
. La màquina SERVIDOR_WEB ha de rebre el servidor DNS 8.8.8.8 i la porta
d'enllaç 10.0.0.1.
. PC1 ha de rebre la IP 172.16.3.8.

ifndef::teacher[]
.Entregar
====
*Captura de la configuració*
====
endif::teacher[]
ifdef::teacher[]
.Solució
====
*Solució*
====
endif::teacher[]

* Reinicieu el servei DHCP a *bilbo*, i demaneu una renovació d'adreça a PC1.
Verifiqueu a PC1 que l'adreça adquirida és l'esperada.

ifndef::teacher[]
.Entregar
====
*Captura de la instrucció per validar l'adreça IP i del seu resultat.*
====
endif::teacher[]
ifdef::teacher[]
.Solució
====
*Solució*
====
endif::teacher[]

== Apartat 5: Configuració de la màquina PC2

* Assumirem ara que a la xarxa 172.16.3.0/24  es barregen màquines conegudes i
registrades (en sabem la MAC i la desem a l'arxiu de configuració) i
desconegudes (imagineu, per exemple, clients WIFI dels que no podem saber la
MAC).

* El DHCP assignarà:
. el rang 172.16.3.30 a 172.16.3.150 a les màquines registrades al DHCP.
. el rang 172.16.3.151 a 172.16.3.254 per a les màquines no registrades.

* Per a totes les màquines d'aquesta subxarxa, la porta d'enllaç és la
172.16.3.1, i els DNS són 172.16.3.2 i 127.16.3.22.

* Per facilitar la feina, només definirem 2 màquines amb adreces MAC
registrades, tindran el nom OFICINA1 i OFICINA2. Inicialment feu coincidir
la mac de PC1 amb OFICINA1, i inventeu-vos la d'OFICINA2.

ifndef::teacher[]
.Entregar
====
*Captura de les ampliacions de l'arxiu de configuració.*
====
endif::teacher[]
ifdef::teacher[]
.Solució
====
*Solució*
====
endif::teacher[]

* Renoveu la IP de PC1 i verifiqueu que adquireix una IP del rang registrat.

ifndef::teacher[]
.Entregar
====
*Captura del terminal amb la renovació i la IP adquirida.*
====
endif::teacher[]
ifdef::teacher[]
.Solució
====
*Solució*
====
endif::teacher[]

* Renoveu la IP de PC2 i verifiqueu que adquireix una IP del rang *NO* registrat.

ifndef::teacher[]
.Entregar
====
*Captura del terminal amb la renovació i la IP adquirida.*
====
endif::teacher[]
ifdef::teacher[]
.Solució
====
*Solució*
====
endif::teacher[]

== Apartat 6: Configuració de PC1 i PC2 a una xarxa diferent

Volem ara traslladar els ordinadors PC1 i PC2 a la seva xarxa 172.16.2.0/24.
Ara, com que el servidor DHCP i els clients es troben a xarxes diferents, les
peticions de broadcast dels clients no arriben al servidor, i no obtenim cap
adreça IP.

Per a resoldre aquesta situació instal·larem al router *saruman* un DHCP relay.
Un relay s'encarrega de rebre les peticions dels clients d'una xarxa i
traspassar-les a l'altra xarxa, i de retornar després les respostes.

* Afegiu al servidor DHCP la configuració de la xarxa 172.16.2.0/24:

. EL servei DHCP repartirà adreces IP en el rang 172.16.2.100 –
172.16.2.254 (ambdues incloses).
. La porta d'enllaç serà 172.16.2.1.

* Esborra de la configuració qualsevol referència a la MAC de PC1 per evitar
conflictes.

ifndef::teacher[]
.Entregar
====
*Captura de la nova configuració.*
====
endif::teacher[]
ifdef::teacher[]
.Solució
====
*Solució*
====
endif::teacher[]

* Instal·leu a *saruman* el paquet *isc-dhcp-relay*. Contesteu a les preguntes
segons la nostra configuració de xarxa.

[TIP]
====
*El relay ha d'escoltar tant a la interfície de xarxa connectada a la xarxa
172.16.2.0/24 com a la que està connectada a la 172.16.3.0/24. Si no posem
aquesta última, no reenvia les respostes del servidor DHCP cap als clients.*
====

Si no funciona a la primera i heu de reconfigurar el relay, utilitzeu
`dpkg-reconfigure`.

* Per comprovar que el relay està en funcionament, ho podem fer amb la
comanda `ps x | grep dhcrelay`.

ifndef::teacher[]
.Entregar
====
*Captura de la sortida de la comanda.*
====
endif::teacher[]
ifdef::teacher[]
.Solució
====
*Solució*
====
endif::teacher[]

* Finalment, connecta PC1 i PC2 al switch intnet2 i comprova que agafen una
IP adequada a la seva xarxa.

ifndef::teacher[]
.Entregar
====
*Comprovació de la IP de PC1 i PC2.*
====
endif::teacher[]
ifdef::teacher[]
.Solució
====
*Solució*
====
endif::teacher[]
